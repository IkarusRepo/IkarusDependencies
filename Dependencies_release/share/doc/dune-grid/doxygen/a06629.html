<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>dune-grid: Integrate a function on a grid</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">dune-grid
   &#160;<span id="projectnumber">2.8.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="a00906.html">dune-grid recipes</a></li>  </ul>
</div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Integrate a function on a grid </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>A fundamental task in any PDE solver is integration of a function over a domain given by a grid: </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ I = \int_\Omega u(x)\,dx = \sum_{e\in E^0} \int_e u(x)\,dx \]" src="form_0.png"/>
</p>
<p> Here we demonstrate how this can be done for a user-defined function in global coordinates.</p>
<p>As always we need to set up a grid first. Here we use the <a class="el" href="a04134.html">Dune::YaspGrid</a> class in four dimensions in order to demonstrate that even dimension larger than three can be used. </p><div class="fragment"><div class="line">  <span class="keyword">const</span> <span class="keywordtype">int</span> dim = 4;</div>
<div class="line">  <span class="keyword">using</span> Grid = <a class="code" href="a04134.html">Dune::YaspGrid&lt;dim&gt;</a>;</div>
<div class="line">  Dune::FieldVector&lt;double,dim&gt; len; <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; l:len) l=1.0;</div>
<div class="line">  std::array&lt;int,dim&gt; cells; <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; c : cells) c=5;</div>
<div class="line">  Grid grid(len,cells);</div>
<div class="ttc" id="aa04134_html"><div class="ttname"><a href="a04134.html">Dune::YaspGrid</a></div><div class="ttdoc">[ provides Dune::Grid ]</div><div class="ttdef"><b>Definition:</b> yaspgrid.hh:160</div></div>
</div><!-- fragment --><p> The <a class="el" href="a00940.html" title="Include standard header files.">Dune</a> grid interface employs the class templates Dune::FieldVector and Dune::FieldMatrix to for small vectors and matrices of compile-time known size in many places, for example to represent positions and Jacobians of certain maps. Here is a small tutorial in the usage of these classes: </p><div class="fragment"><div class="line">  Dune::FieldVector&lt;double,4&gt; x({1,2,3,4}); <span class="comment">// make a vector</span></div>
<div class="line">  <span class="keyword">auto</span> y(x); <span class="comment">// copy constructor</span></div>
<div class="line">  y *= 1.0/3.0; <span class="comment">// scaling</span></div>
<div class="line">  [[maybe_unused]] <span class="keyword">auto</span> s = x*y; <span class="comment">// scalar product</span></div>
<div class="line">  [[maybe_unused]] <span class="keyword">auto</span> norm = x.two_norm(); <span class="comment">// Euclidean norm</span></div>
<div class="line">  Dune::FieldMatrix&lt;double,4,4&gt; A({{1,0,0,0},{0,1,0,0},{0,0,1,0},{0,0,0,1}}); <span class="comment">// make a matrix</span></div>
<div class="line">  A.mv(x,y); <span class="comment">// matvec: y = Ax</span></div>
<div class="line">  A.usmv(0.5,x,y); <span class="comment">// axpy: y += 0.5*Ax</span></div>
</div><!-- fragment --><p> Next we define the function to integrate as a generic lambda function. We expect the argument x to be an instance of type Dune::FieldVector: </p><div class="fragment"><div class="line">  <span class="keyword">auto</span> u = [](<span class="keyword">const</span> <span class="keyword">auto</span>&amp; x){<span class="keywordflow">return</span> std::exp(x.two_norm());};</div>
</div><!-- fragment --><p> First we demonstrate how to compute an approximation to the integral by using the simple midpoint rule. This means traversing all elements, evalute the function at the barycenter of the element, multiplying with the volume of the element and summing up: </p><div class="fragment"><div class="line">  <span class="keywordtype">double</span> integral=0.0;</div>
<div class="line">  <span class="keyword">auto</span> gv = grid.leafGridView(); <span class="comment">// extract the grid view</span></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; e : <a class="code" href="a00915.html#ga9bbe243bea9b505e0fa4f3ab0005c7f5">elements</a>(gv))</div>
<div class="line">    integral += u(e.geometry().center())*e.geometry().volume();</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;integral = &quot;</span> &lt;&lt; integral &lt;&lt; std::endl;</div>
<div class="ttc" id="aa00915_html_ga9bbe243bea9b505e0fa4f3ab0005c7f5"><div class="ttname"><a href="a00915.html#ga9bbe243bea9b505e0fa4f3ab0005c7f5">Dune::GridView::elements</a></div><div class="ttdeci">IteratorRange&lt;... &gt; elements(const GV &amp;gv)</div><div class="ttdoc">Iterates over all elements / cells (entities with codimension 0) of a GridView.</div></div>
</div><!-- fragment --><p> A more accurate approximation of the integral for sufficiently smooth functions can be computed by quadrature rules. These are available in <a class="el" href="a00940.html" title="Include standard header files.">Dune</a> for all the different element types and various integration orders. This simply requires an additional loop over the quadrature points within an element: </p><div class="fragment"><div class="line">  <span class="keywordtype">double</span> integral2 = 0.0;</div>
<div class="line">  <span class="keyword">using</span> QR = Dune::QuadratureRules&lt;Grid::ctype,dim&gt;;</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; e : <a class="code" href="a00915.html#ga9bbe243bea9b505e0fa4f3ab0005c7f5">elements</a>(gv))</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">auto</span> geo = e.geometry();</div>
<div class="line">      <span class="keyword">auto</span> quadrature = QR::rule(geo.type(),5);</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; qp : quadrature)</div>
<div class="line">        integral2 += u(geo.global(qp.position()))</div>
<div class="line">          *geo.integrationElement(qp.position())*qp.weight();</div>
<div class="line">    }</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;integral2 = &quot;</span> &lt;&lt; integral2 &lt;&lt; std::endl;</div>
</div><!-- fragment --><p> For integrating the divergence of a vector field <img class="formulaInl" alt="$f$" src="form_1.png"/> we might use the following formula: </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ I = \int_\Omega \nabla\cdot f(x)\,dx = \int_{\partial \Omega} f(x)\cdot n(x) \,ds = \sum_{e\in E^0} \int_{\partial e\cap \partial \Omega} f(x)\cdot n(x) \,ds. \]" src="form_2.png"/>
</p>
<p> This is implemented by the following snippet illustrating the use of intersections: </p><div class="fragment"><div class="line">  <span class="keyword">auto</span> f = [](<span class="keyword">const</span> <span class="keyword">auto</span>&amp; x){<span class="keywordflow">return</span> x;};</div>
<div class="line">  <span class="keywordtype">double</span> divergence=0.0;</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; i : <a class="code" href="a00915.html#ga9bbe243bea9b505e0fa4f3ab0005c7f5">elements</a>(gv)) {</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; I : <a class="code" href="a00915.html#ga0927181ebf10ed59531e262a63f92daf">intersections</a>(gv,i))</div>
<div class="line">      <span class="keywordflow">if</span> (!I.neighbor())</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">auto</span> geoI = I.geometry();</div>
<div class="line">          divergence += f(geoI.center())*I.centerUnitOuterNormal()*geoI.volume();</div>
<div class="line">        }</div>
<div class="line">  }</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;divergence = &quot;</span> &lt;&lt; divergence &lt;&lt; std::endl;</div>
<div class="ttc" id="aa00915_html_ga0927181ebf10ed59531e262a63f92daf"><div class="ttname"><a href="a00915.html#ga0927181ebf10ed59531e262a63f92daf">Dune::Entity::intersections</a></div><div class="ttdeci">IteratorRange&lt;... &gt; intersections(const GV &amp;gv, const Entity &amp;e)</div><div class="ttdoc">Iterates over all Intersections  of an Entity with respect to the given GridView.</div></div>
</div><!-- fragment --><p> Full example code: <a class="el" href="a04343.html">recipe-integration.cc</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
